<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>町田工科高校 周辺バス接近（町田駅方面・マップなし）</title>
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Yu Gothic", Meiryo, sans-serif; background:#f8fafc }
    .container { max-width: 860px; margin: 0 auto; padding: 16px; }
    header { margin-bottom: 8px; }
    h1 { font-size: 20px; margin: 0 0 6px; }
    .muted { color: #6b7280; font-size: 12px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 820px){ .grid { grid-template-columns: 1fr; } }
    .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 12px; background:#fff; box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
    .title { font-weight: 700; font-size: 14px; }
    .row { display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 6px; }
    .btn { display:inline-flex; align-items:center; gap:6px; border:1px solid #d1d5db; padding:6px 10px; border-radius:999px; text-decoration:none; color:#111827; font-size:12px; background:#fff; }
    .btn:hover{ background:#f3f4f6; }
    .eta { display:flex; justify-content:space-between; gap:8px; padding:6px 0; border-top:1px dashed #e5e7eb; align-items:baseline; }
    .badge { padding:2px 8px; border-radius:999px; font-size:12px; background:#eef2ff; }
    .updated { font-size: 12px; color:#6b7280; margin-top: 10px; }
    .err { color:#b91c1c; font-size:12px; }
  </style>
</head>
<body>
  <main class="container">
    <header>
      <h1>町田工科高校 周辺バス接近（町田駅方面）</h1>
      <div class="muted">※ 20秒ごとに <code>/api/arrivals</code> から更新します。公式サイトの都合で取得できない場合はフォールバック表示になります。</div>
    </header>

    <section id="stops" class="grid" aria-live="polite"></section>
    <div id="lastUpdated" class="updated"></div>
  </main>

  <script>
    // === 対象停留所（町田駅方面） ===
    const STOPS = [
      { stop_id: "machiko_kougyoumae_toward_machida", name: "町田工業高校前（町田駅方面）", links:{ kanachu:"https://real.kanachu.jp/sp/DisplayApproachFrom?fNO=22264&pNO=2" } },
      { stop_id: "kamijuku_toward_machida", name: "上宿（町田駅方面）", links:{ kanachu:"https://real.kanachu.jp/sp/DisplayApproachFrom?fNO=22011&pNO=2" } },
      { stop_id: "tadao_park_toward_machida", name: "忠生公園前（町田駅方面）", links:{ kanachu:"https://real.kanachu.jp/sp/DisplayApproachFrom?fNO=22041&pNO=2" } },
      { stop_id: "ja_tadao_branch_toward_machida", name: "JA忠生支店前（町田駅方面）", links:{ kanachu:"https://real.kanachu.jp/sp/DisplayApproachFrom?fNO=22280&pNO=2" } },
    ];

    // フォールバック（API不達時の簡易表示）
    const FALLBACK_ARRIVALS = {
      machiko_kougyoumae_toward_machida: [ { route:"町32", headsign:"町田バスセンター", minutes:3 }, { route:"町32", headsign:"町田バスセンター", minutes:12 } ],
      kamijuku_toward_machida: [ { route:"町32", headsign:"町田バスセンター", minutes:7 } ],
      tadao_park_toward_machida: [ { route:"町32", headsign:"町田バスセンター", minutes:5 } ],
      ja_tadao_branch_toward_machida: [ { route:"町32", headsign:"町田バスセンター", minutes:9 } ],
    };

    let arrivals = { ...FALLBACK_ARRIVALS };

    const $stops = document.getElementById('stops');
    const $last = document.getElementById('lastUpdated');

    function stopCard(stop){
      const list = (arrivals[stop.stop_id] || []).slice(0, 6);
      const wrap = document.createElement('div');
      wrap.className = 'card';
      wrap.innerHTML = `
        <div class="title">${stop.name}</div>
        <div class="row">
          <a class="btn" href="${stop.links.kanachu}" target="_blank" rel="noopener">公式ロケ</a>
        </div>
        <div>
          ${list.length===0 ? '<div class="muted" style="margin-top:6px">接近情報なし</div>' : list.map(a=>`
            <div class="eta">
              <div><span class="badge">${a.route||'-'}</span> ${a.headsign||''}</div>
              <div>${a.minutes===0 ? '到着/まもなく' : `約 ${a.minutes} 分`}</div>
            </div>
          `).join('')}
        </div>`;
      return wrap;
    }

    function render(){
      $stops.innerHTML='';
      STOPS.forEach(s=> $stops.appendChild(stopCard(s)));
    }

    async function poll(){
      try{
        const ids = STOPS.map(s=>s.stop_id).join(',');
        const res = await fetch(`/api/arrivals?stop_ids=${ids}`, { cache: 'no-store' });
        if(res.ok){
          const data = await res.json();
          if(Object.keys(data).length){
            arrivals = data;
            render();
            $last.textContent = '更新: ' + new Date().toLocaleTimeString('ja-JP',{hour12:false});
          }
        }else{
          $last.innerHTML = `<span class="err">サーバ応答エラー (${res.status}) — フォールバック表示中</span>`;
        }
      }catch{
        $last.innerHTML = `<span class="err">取得失敗 — フォールバック表示中</span>`;
      }finally{
        setTimeout(poll, 20000);
      }
    }

    render();
    poll();
  </script>
</body>
</html>
