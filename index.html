<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>町田工科高校 周辺バス接近（静的地図画像版）</title>
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Yu Gothic", Meiryo, sans-serif; }
    #app { display: grid; grid-template-columns: 360px 1fr; height: 100%; }
    #sidebar { border-right: 1px solid #e5e7eb; padding: 14px; overflow: auto; }
    #sidebar h1 { font-size: 18px; margin: 0 0 6px; }
    #sidebar .muted { color: #6b7280; font-size: 12px; }
    #mapwrap { height: 100%; display:flex; align-items:center; justify-content:center; background:#f8fafc; }
    .mapimg { max-width: 100%; height: auto; display:block; }
    .stop-card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 10px; margin: 10px 0; box-shadow: 0 1px 2px rgba(0,0,0,0.04); background:#fff; }
    .stop-title { font-weight: 700; font-size: 14px; }
    .eta-row { display: flex; justify-content: space-between; gap: 8px; padding: 6px 0; border-top: 1px dashed #e5e7eb; align-items: baseline; }
    .badge { padding: 2px 8px; border-radius: 999px; font-size: 12px; background: #eef2ff; }
    .btn { display:inline-flex; align-items:center; gap:6px; border:1px solid #d1d5db; padding:6px 10px; border-radius:999px; text-decoration:none; color:#111827; font-size:12px; background:#fff; }
    .btn:hover{ background:#f9fafb; }
    .row { display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; }
    .updated { font-size: 11px; color:#6b7280; margin-top:6px; }
    .err { color:#b91c1c; font-size:12px; }
    @media (max-width: 800px){ #app { grid-template-columns: 1fr; } #sidebar { height: 50vh; } }
  </style>
</head>
<body>
  <div id="app">
    <aside id="sidebar">
      <h1>町田工科高校 周辺バス接近</h1>
      <div class="muted">対象：<strong>町田駅方面（町田バスセンター行など）</strong></div>
      <div class="muted">※ 地図は <strong>静的画像</strong> です（APIキー不要）。バス接近は20秒ごとに更新します。</div>

      <div id="stops"></div>
      <div id="lastUpdated" class="updated" aria-live="polite"></div>

      <hr style="margin:12px 0; border:none; border-top:1px solid #eee"/>
      <details>
        <summary style="cursor:pointer; font-size:12px; color:#6b7280">地図を大きく見る（OpenStreetMap）</summary>
        <div class="muted">OpenStreetMap の本体で周辺を拡大できます。</div>
        <div style="margin-top:6px">
          <a class="btn" href="https://www.openstreetmap.org/?mlat=35.575472&mlon=139.421472#map=15/35.5755/139.4215" target="_blank" rel="noopener">OpenStreetMap を開く</a>
        </div>
      </details>
    </aside>

    <div id="mapwrap">
      <!-- OSMの静的マップ画像（staticmap.openstreetmap.de）
           学校：赤ピン、4停留所：青ピン。サイズやズームはURLのパラメータで調整可能。
           参考：https://staticmap.openstreetmap.de/ -->
      <a href="https://www.openstreetmap.org/?mlat=35.575472&mlon=139.421472#map=15/35.5755/139.4215" target="_blank" rel="noopener">
        <img class="mapimg" alt="町田工科高校 周辺の地図（静的画像）" src="https://staticmap.openstreetmap.de/staticmap.php?center=35.575472,139.421472&zoom=15&size=900x650&maptype=mapnik&markers=35.575472,139.421472,red-pushpin&markers=35.57585,139.4224,blue-pushpin&markers=35.5769,139.4247,blue-pushpin&markers=35.5719,139.4210,blue-pushpin&markers=35.576848,139.419378,blue-pushpin" />
      </a>
    </div>
  </div>

  <script>
    // === 停留所＆リンク ===
    const STOPS = [
      { stop_id: "machiko_kougyoumae_toward_machida", name: "町田工業高校前（町田駅方面）", links:{ kanachu:"http://real.kanachu.jp/sp/DisplayApproachFrom?fNO=22264&pNO=2", yahoo:"https://map.yahoo.co.jp/" } },
      { stop_id: "kamijuku_toward_machida", name: "上宿（町田駅方面）", links:{ kanachu:"http://real.kanachu.jp/sp/DisplayApproachFrom?fNO=22011&pNO=2", yahoo:"https://map.yahoo.co.jp/" } },
      { stop_id: "tadao_park_toward_machida", name: "忠生公園前（町田駅方面）", links:{ kanachu:"http://real.kanachu.jp/sp/DisplayApproachFrom?fNO=22041&pNO=2", yahoo:"https://map.yahoo.co.jp/" } },
      { stop_id: "ja_tadao_branch_toward_machida", name: "JA忠生支店前（町田駅方面）", links:{ kanachu:"http://real.kanachu.jp/sp/DisplayApproachFrom?fNO=22280&pNO=2", yahoo:"https://map.yahoo.co.jp/" } },
    ];

    // === フォールバック（API停止時の暫定表示） ===
    const FALLBACK_ARRIVALS = {
      machiko_kougyoumae_toward_machida: [ { route:"町32", headsign:"町田バスセンター", minutes:3 }, { route:"町32", headsign:"町田バスセンター", minutes:12 } ],
      kamijuku_toward_machida: [ { route:"町32", headsign:"町田バスセンター", minutes:7 } ],
      tadao_park_toward_machida: [ { route:"町32", headsign:"町田バスセンター", minutes:5 } ],
      ja_tadao_branch_toward_machida: [ { route:"町32", headsign:"町田バスセンター", minutes:9 } ],
    };

    let arrivals = { ...FALLBACK_ARRIVALS };

    const stopsEl = document.getElementById('stops');
    const lastEl = document.getElementById('lastUpdated');

    function renderStopCard(stop) {
      const div = document.createElement('div');
      div.className = 'stop-card';
      const list = (arrivals[stop.stop_id] || []).slice(0, 4);

      div.innerHTML = `
        <div class="stop-title">${stop.name}</div>
        <div class="row" style="margin-top:6px">
          <a class="btn" href="${stop.links.kanachu}" target="_blank" rel="noopener">公式ロケ</a>
          <a class="btn" href="${stop.links.yahoo}" target="_blank" rel="noopener">Yahoo!で確認</a>
        </div>
        <div class="eta-list">
          ${list.length === 0 ? '<div class="muted" style="margin-top:8px">接近情報なし</div>' : list.map(a => `
            <div class="eta-row">
              <div><span class="badge">${a.route || '-'}</span> ${a.headsign || ''}</div>
              <div>${typeof a.minutes === 'number' ? `約 ${a.minutes} 分` : (a.minutes || '')}</div>
            </div>
          `).join('')}
        </div>
      `;
      return div;
    }

    function renderAll() {
      stopsEl.innerHTML = '';
      STOPS.forEach(s => stopsEl.appendChild(renderStopCard(s)));
    }

    async function poll(){
      try{
        const ids = STOPS.map(s=>s.stop_id).join(',');
        const res = await fetch(`/api/arrivals?stop_ids=${ids}`, { cache: 'no-store' });
        if(res.ok){
          const data = await res.json();
          if(Object.keys(data).length){
            arrivals = data;
            renderAll();
            const t = new Date();
            lastEl.textContent = `更新: ${t.toLocaleTimeString('ja-JP', { hour12:false })}`;
          }
        } else {
          lastEl.innerHTML = `<span class="err">サーバ応答エラー (${res.status}) — フォールバック表示中</span>`;
        }
      }catch(err){
        lastEl.innerHTML = `<span class="err">取得失敗 — フォールバック表示中</span>`;
      }finally{
        setTimeout(poll, 20000);
      }
    }

    renderAll();
    poll();
  </script>
</body>
</html>
